version: '3.8'

services:
  nats:
    image: nats:alpine
    container_name: mephi-nats
    command: "-js -m 8222"
    ports:
      - "4222:4222"
      - "8222:8222"
    networks:
      - mephi-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "4222"]
      interval: 3s
      timeout: 3s
      retries: 10
      start_period: 5s
    restart: unless-stopped

  metrics-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mephi-bigdata-metrics
    env_file:
      - .env
    depends_on:
      nats:
        condition: service_healthy
    networks:
      - mephi-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    privileged: true
    restart: unless-stopped

  zookeeper:
    image: zookeeper:3.9
    container_name: mephi-zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOO_MY_ID: 1
      ZOO_SERVERS: server.1=0.0.0.0:2888:3888;2181
    networks:
      - mephi-network
    restart: unless-stopped

  hbase:
    image: dajobe/hbase:latest
    container_name: mephi-hbase
    hostname: hbase
    ports:
      - "16000:16000"  # HBase Master
      - "16010:16010"  # HBase Master Web UI
      - "16020:16020"  # HBase RegionServer
      - "16030:16030"  # HBase RegionServer Web UI
      - "9090:9090"    # Thrift
      - "9095:9095"    # REST
    environment:
      HBASE_CONF_hbase_rootdir: /hbase-data
      HBASE_CONF_hbase_zookeeper_quorum: zookeeper
      HBASE_CONF_hbase_cluster_distributed: "true"
    depends_on:
      - zookeeper
    networks:
      - mephi-network
    volumes:
      - hbase-data:/hbase-data
      - hbase-logs:/var/log/hbase
    restart: unless-stopped

  nifi:
    image: apache/nifi:1.25.0
    container_name: mephi-nifi
    hostname: nifi
    entrypoint: ["/opt/nifi/scripts/start.sh"]
    ports:
      - "8443:8443"    # NiFi Web UI (HTTPS)
    environment:
      SINGLE_USER_CREDENTIALS_USERNAME: admin
      SINGLE_USER_CREDENTIALS_PASSWORD: adminadminadmin
      NIFI_JVM_HEAP_INIT: 2g
      NIFI_JVM_HEAP_MAX: 4g
    depends_on:
      - hbase
      - nats
    networks:
      - mephi-network
    volumes:
      - nifi-database:/opt/nifi/nifi-current/database_repository
      - nifi-flowfile:/opt/nifi/nifi-current/flowfile_repository
      - nifi-content:/opt/nifi/nifi-current/content_repository
      - nifi-provenance:/opt/nifi/nifi-current/provenance_repository
      - nifi-state:/opt/nifi/nifi-current/state
      - nifi-logs:/opt/nifi/nifi-current/logs
      - ./scripts:/opt/nifi/custom-scripts:ro
    restart: unless-stopped

  spark:
    image: apache/spark:3.5.0
    container_name: mephi-spark
    user: root
    command: /opt/spark/bin/spark-class org.apache.spark.deploy.master.Master
    ports:
      - "8080:8080"
      - "7077:7077"
    volumes:
      - ./spark-app/build/libs:/opt/spark-apps
    networks:
      - mephi-network
    depends_on:
      - hbase
    restart: unless-stopped

  storm-nimbus:
    image: storm:2.6.0
    container_name: mephi-storm-nimbus
    hostname: mephi-storm-nimbus
    command: storm nimbus
    ports:
      - "6627:6627"
    environment:
      STORM_ZOOKEEPER_SERVERS: mephi-zookeeper
      STORM_ZOOKEEPER_PORT: "2181"
      STORM_LOCAL_HOSTNAME: mephi-storm-nimbus
    depends_on:
      - zookeeper
    networks:
      - mephi-network
    volumes:
      - ./storm-app/build/libs:/storm-jars:ro
      - ./storm-app/storm.yaml:/conf/storm.yaml
      - storm-nimbus-data:/var/lib/storm
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  storm-supervisor:
    image: storm:2.6.0
    container_name: mephi-storm-supervisor
    command: storm supervisor
    ports:
      - "6700:6700"
      - "6701:6701"
      - "6702:6702"
      - "6703:6703"
    environment:
      STORM_ZOOKEEPER_SERVERS: mephi-zookeeper
      STORM_ZOOKEEPER_PORT: "2181"
    depends_on:
      - zookeeper
      - storm-nimbus
    networks:
      - mephi-network
    volumes:
      - ./storm-app/build/libs:/storm-jars:ro
      - ./storm-app/storm.yaml:/conf/storm.yaml
      - storm-supervisor-data:/var/lib/storm
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  storm-ui:
    image: storm:2.6.0
    container_name: mephi-storm-ui
    command: storm ui
    ports:
      - "8081:8081"
    environment:
      STORM_ZOOKEEPER_SERVERS: mephi-zookeeper
      STORM_ZOOKEEPER_PORT: "2181"
    depends_on:
      - zookeeper
      - storm-nimbus
    networks:
      - mephi-network
    volumes:
      - ./storm-app/storm.yaml:/conf/storm.yaml
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  spark-app:
    image: apache/spark:3.5.0
    container_name: mephi-spark-app
    user: root
    command: >
      sh -c "while true; do
        echo 'Starting Spark job...';
        /opt/spark/bin/spark-submit
        --class NetworkTrafficAnalyzer
        --master local[*]
        /opt/spark-apps/spark-app.jar;
        echo 'Spark job completed. Sleeping 60 seconds...';
        sleep 60;
      done"
    volumes:
      - ./spark-app/build/libs:/opt/spark-apps
    networks:
      - mephi-network
    depends_on:
      - hbase
      - spark
    restart: unless-stopped

  storm-app:
    image: storm:2.6.0
    container_name: mephi-storm-app
    command: >
      sh -c "echo 'Waiting 20 seconds for nimbus to start...';
      sleep 20;
      echo 'Submitting topology...';
      storm jar /storm-jars/storm-app.jar SpikeDetectorTopology ||
      (echo 'Failed to submit topology' && tail -f /dev/null)"
    environment:
      STORM_ZOOKEEPER_SERVERS: mephi-zookeeper
      STORM_ZOOKEEPER_PORT: "2181"
      STORM_LOCAL_HOSTNAME: mephi-storm-app
    depends_on:
      - storm-nimbus
      - storm-supervisor
      - nats
    networks:
      - mephi-network
    volumes:
      - ./storm-app/build/libs:/storm-jars:ro
      - ./storm-app/storm.yaml:/conf/storm.yaml
    restart: on-failure

networks:
  mephi-network:
    driver: bridge

volumes:
  hbase-data:
  hbase-logs:
  nifi-conf:
  nifi-database:
  nifi-flowfile:
  nifi-content:
  nifi-provenance:
  nifi-state:
  nifi-logs:
  storm-nimbus-data:
  storm-supervisor-data: